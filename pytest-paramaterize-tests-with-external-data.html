<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

        <title>[py.test] Paramaterize tests with external data</title>

            <link href="http://remusao.github.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Pythux Full Atom Feed" />
            <link href="http://remusao.github.com/feeds/python.atom.xml" type="application/atom+xml" rel="alternate" title="Pythux Categories Atom Feed" />

        <!-- Bootstrap Core CSS -->
        <link href="http://remusao.github.com/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://remusao.github.com/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://remusao.github.com/theme/css/code_blocks/monokai.css" rel="stylesheet">


        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->




        <meta name="tags" contents="python" />
        <meta name="tags" contents="pytest" />


			<meta property="og:locale" content="en">
		<meta property="og:site_name" content="Pythux">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="http://remusao.github.com/pytest-paramaterize-tests-with-external-data.html">
	<meta property="og:title" content="[py.test] Paramaterize tests with external data">
	<meta property="og:description" content="">
	<meta property="og:image" content="http://remusao.github.com/static/metal.jpg">
	<meta property="article:published_time" content="2014-11-26 15:00:00+01:00">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://remusao.github.com/">Pythux</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                            <li><a href="http://remusao.github.com/pages/about.html">About</a></li>
                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('static/metal.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>[py.test] Paramaterize tests with external data</h1>
                        <span class="meta">Posted by
                                <a href="http://remusao.github.com/author/pythux.html">Pythux</a>
                             on Wed 26 November 2014
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>I recently began to make heavy use of <a href="http://pytest.org/latest/">py.test</a>
in my day-to-day Python development. It's a wonderful tool, but I won't
explain to you every features it provides and why it's awesome. Instead,
I'll explain how I managed to cleanly externalize the data used for my
tests in external files (that can be of any format: yaml, json, python
files). The idea here is to <em>separate the code that performs the test</em>,
from the <em>input data used to perform the test</em>.</p>
<p><code>test_feature.py</code></p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">test_my_feature</span><span class="p">(</span><span class="n">one_example</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">one_example</span>
</pre></div>


<p><code>data_feature.yaml</code></p>
<div class="highlight"><pre><span class="l-Scalar-Plain">tests</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">test1</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">...</span>
    <span class="l-Scalar-Plain">test2</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">...</span>
</pre></div>


<h2>First solution: yield</h2>
<p>The first solution would be to use <code>yield</code> to generate tests, as it's supported
by <code>py.test</code> (as long as you don't want to use fixtures in your test function...).</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="c"># perform your test</span>

<span class="k">def</span> <span class="nf">test_feature</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">generate_tests</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">check</span><span class="p">,</span> <span class="n">test</span>
</pre></div>


<p>Here, <code>py.test</code> will understand that <code>test_feature</code> will yield several tests and that
the <code>check</code> function must be used to perform the test, so it is almost equivalent to do:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">test_feature</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">generate_tests</span><span class="p">():</span>
        <span class="n">check</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>
</pre></div>


<p>Except that in this last snippet of code, the tests will stop as soon as one fails.
With the <code>yield</code>-version, every tests will be ran even if some fail. This is useful
if you have lot of tests, and you want to know which ones fail (not just the first one).</p>
<p><strong>Problem</strong>: if you want to use fixtures with your <code>test_feature</code> functions, it breaks:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="n">example</span><span class="p">):</span>
    <span class="c"># perform your test</span>

<span class="k">def</span> <span class="nf">test_feature</span><span class="p">(</span><span class="n">my_fixture</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">generate_tests</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">check</span><span class="p">,</span> <span class="n">test</span>
</pre></div>


<p>This will tell you that <code>test_feature</code> expects one argument but that none are provided.</p>
<p>End of the story...
Wait, no, <code>py.test</code> is awesome remember? So there must be a solution!</p>
<h2>Parametrization</h2>
<p>One of the cool features of <code>py.test</code> is the ability to add parameters on our
tests or fixtures, so that a test is ran once for each parameter (from <a href="http://pytest.org/latest/parametrize.html">py.test doc</a>):</p>
<div class="highlight"><pre><span class="c"># content of test_expectation.py</span>
<span class="kn">import</span> <span class="nn">pytest</span>
<span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s">&quot;input,expected&quot;</span><span class="p">,</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">&quot;3+5&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&quot;2+4&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="p">(</span><span class="s">&quot;6*9&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span>
<span class="p">])</span>
<span class="k">def</span> <span class="nf">test_eval</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>


<div class="highlight"><pre><span class="err">$</span> <span class="n">py</span><span class="o">.</span><span class="n">test</span>
<span class="o">===========================</span> <span class="n">test</span> <span class="n">session</span> <span class="n">starts</span> <span class="o">============================</span>
<span class="n">platform</span> <span class="n">linux</span> <span class="o">--</span> <span class="n">Python</span> <span class="mf">3.4</span><span class="o">.</span><span class="mi">0</span> <span class="o">--</span> <span class="n">py</span><span class="o">-</span><span class="mf">1.4</span><span class="o">.</span><span class="mi">26</span> <span class="o">--</span> <span class="n">pytest</span><span class="o">-</span><span class="mf">2.6</span><span class="o">.</span><span class="mi">4</span>
<span class="n">collected</span> <span class="mi">3</span> <span class="n">items</span>

<span class="n">test_expectation</span><span class="o">.</span><span class="n">py</span> <span class="o">..</span><span class="n">F</span>

<span class="o">=================================</span> <span class="n">FAILURES</span> <span class="o">=================================</span>
<span class="n">____________________________</span> <span class="n">test_eval</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="mi">9</span><span class="o">-</span><span class="mi">42</span><span class="p">]</span> <span class="n">_____________________________</span>

<span class="nb">input</span> <span class="o">=</span> <span class="s">&#39;6*9&#39;</span><span class="p">,</span> <span class="n">expected</span> <span class="o">=</span> <span class="mi">42</span>

    <span class="nd">@pytest.mark.parametrize</span><span class="p">(</span><span class="s">&quot;input,expected&quot;</span><span class="p">,</span> <span class="p">[</span>
        <span class="p">(</span><span class="s">&quot;3+5&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;2+4&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&quot;6*9&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">),</span>
    <span class="p">])</span>
    <span class="k">def</span> <span class="nf">test_eval</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
<span class="o">&gt;</span>       <span class="k">assert</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
<span class="n">E</span>       <span class="k">assert</span> <span class="mi">54</span> <span class="o">==</span> <span class="mi">42</span>
<span class="n">E</span>        <span class="o">+</span>  <span class="n">where</span> <span class="mi">54</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&#39;6*9&#39;</span><span class="p">)</span>

<span class="n">test_expectation</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">8</span><span class="p">:</span> <span class="ne">AssertionError</span>
<span class="o">====================</span> <span class="mi">1</span> <span class="n">failed</span><span class="p">,</span> <span class="mi">2</span> <span class="n">passed</span> <span class="ow">in</span> <span class="mf">0.01</span> <span class="n">seconds</span> <span class="o">====================</span>
</pre></div>


<p>So here our <code>test_eval</code> function has been called <em>three times</em>. Once for each parameter.
Great! But what if you want your parameters to come from another file, or from a function.
In other words, what if you want to <em>dynamically parametrize</em> your function?</p>
<h2>Hooks at the rescue</h2>
<p><a href="http://pytest.org/latest/plugins.html#well-specified-hooks">Hooks</a> allow you to plug code into <code>py.test</code> at diffent stages of the test run.
The hook that can be useful for us is <code>pytest_generate_tests</code> that will allow
to generate several calls to the same test function, but with different arguments
(from <a href="http://pytest.org/latest/funcargs.html#basic-generated-test-example">py.test doc</a>):</p>
<div class="highlight"><pre><span class="c"># content of test_example.py</span>
<span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>
    <span class="k">if</span> <span class="s">&quot;numiter&quot;</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">funcargnames</span><span class="p">:</span>
        <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s">&quot;numiter&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="n">numiter</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">numiter</span> <span class="o">&lt;</span> <span class="mi">9</span>
</pre></div>


<div class="highlight"><pre><span class="err">$</span> <span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">test_example</span><span class="o">.</span><span class="n">py</span>
<span class="o">===========================</span> <span class="n">test</span> <span class="n">session</span> <span class="n">starts</span> <span class="o">============================</span>
<span class="n">platform</span> <span class="n">linux2</span> <span class="o">--</span> <span class="n">Python</span> <span class="mf">2.7</span><span class="o">.</span><span class="mi">1</span> <span class="o">--</span> <span class="n">pytest</span><span class="o">-</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">4</span>
<span class="n">collecting</span> <span class="o">...</span> <span class="n">collected</span> <span class="mi">10</span> <span class="n">items</span>

<span class="n">test_example</span><span class="o">.</span><span class="n">py</span> <span class="o">.........</span><span class="n">F</span>

<span class="o">=================================</span> <span class="n">FAILURES</span> <span class="o">=================================</span>
<span class="n">_______________________________</span> <span class="n">test_func</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="n">_______________________________</span>

<span class="n">numiter</span> <span class="o">=</span> <span class="mi">9</span>

    <span class="k">def</span> <span class="nf">test_func</span><span class="p">(</span><span class="n">numiter</span><span class="p">):</span>
<span class="o">&gt;</span>       <span class="k">assert</span> <span class="n">numiter</span> <span class="o">&lt;</span> <span class="mi">9</span>
<span class="n">E</span>       <span class="k">assert</span> <span class="mi">9</span> <span class="o">&lt;</span> <span class="mi">9</span>

<span class="n">test_example</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">6</span><span class="p">:</span> <span class="ne">AssertionError</span>
<span class="o">====================</span> <span class="mi">1</span> <span class="n">failed</span><span class="p">,</span> <span class="mi">9</span> <span class="n">passed</span> <span class="ow">in</span> <span class="mf">0.02</span> <span class="n">seconds</span> <span class="o">====================</span>
</pre></div>


<p>Great, so the last things to do is:</p>
<ol>
<li>Detect functions that make use of a fixture whose name starts with <code>data_</code></li>
<li>Load the corresponding file or resource for the test source</li>
<li>Parametrize the function with each of the data</li>
</ol>
<p>For example, here is what you can do:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">pytest_generate_tests</span><span class="p">(</span><span class="n">metafunc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; This allows us to load tests from external files by</span>
<span class="sd">    parametrizing tests with each test case found in a data_X</span>
<span class="sd">    file &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fixture</span> <span class="ow">in</span> <span class="n">metafunc</span><span class="o">.</span><span class="n">fixturenames</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fixture</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;data_&#39;</span><span class="p">):</span>
            <span class="c"># Load associated test data</span>
            <span class="n">tests</span> <span class="o">=</span> <span class="n">load_tests</span><span class="p">(</span><span class="n">fixture</span><span class="p">)</span>
            <span class="n">metafunc</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="n">fixture</span><span class="p">,</span> <span class="n">tests</span><span class="p">)</span>
</pre></div>


<p>Here, the <code>load_tests</code> function takes as argument the name of the fixture <code>data_X</code>
and will:</p>
<ol>
<li>Load the corresponding file</li>
<li>Extract the different test-cases</li>
<li>Return a list of all the cases</li>
</ol>
<p>For example, if your tests are stored in a Python file:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">importlib</span>


<span class="k">def</span> <span class="nf">load_tests</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="c"># Load module which contains test data</span>
    <span class="n">tests_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="c"># Tests are to be found in the variable `tests` of the module</span>
    <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests_module</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
        <span class="k">yield</span> <span class="n">test</span>
</pre></div>


<p>The data file (<code>data_my_feature.py</code>) could look something like:</p>
<div class="highlight"><pre><span class="n">tests</span> <span class="o">=</span> <span class="p">[</span>
    <span class="mi">1</span><span class="p">,</span>
    <span class="mi">2</span><span class="p">,</span>
    <span class="mi">3</span><span class="p">,</span>
    <span class="mi">4</span><span class="p">,</span>
    <span class="mi">5</span><span class="p">,</span>
    <span class="mi">6</span><span class="p">,</span>
    <span class="mi">7</span><span class="p">,</span>
    <span class="mi">8</span><span class="p">,</span>
    <span class="mi">9</span>
<span class="p">]</span>
</pre></div>


<p>The test function will then be invoked for each case.</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">test_feature</span><span class="p">(</span><span class="n">data_my_feature</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">data_my_feature</span> <span class="o">&lt;</span> <span class="mi">5</span>
</pre></div>


<h2>Conclusion</h2>
<p>Here it's not really interesting, but the benefits are numerous:</p>
<ol>
<li>storing your data in a database, or in yaml/json formatted files, or whatever</li>
<li>other people can add tests to your project, without having to dig into the code</li>
<li>provide a common format to define tests in external files</li>
<li>reuse the same data for several tests</li>
<li>the data is not hard-coded in Python source-code</li>
</ol>
<p>TL;DR: <code>py.test</code> is awesome. Make tests. Get data for your tests from external sources.</p>
    </article>

        <div class="tags">
            <p>tags: <a href="http://remusao.github.com/tag/python.html">python</a>, <a href="http://remusao.github.com/tag/pytest.html">pytest</a>, </p>
        </div>

    <hr>

        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'pythux';
                var disqus_identifier = 'pytest-paramaterize-tests-with-external-data.html';
                var disqus_url = 'http://remusao.github.com/pytest-paramaterize-tests-with-external-data.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//pythux.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="http://twitter.com/Pythux">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://github.com/remusao">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
                    <p class="copyright text-muted">Blog powered by <a href="http://getpelican.com">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://remusao.github.com/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://remusao.github.com/theme/js/bootstrap.min.js"></script>

        <!-- Custom Theme JavaScript -->
        <script src="http://remusao.github.com/theme/js/clean-blog.min.js"></script>

    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-57162019-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'pythux';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>